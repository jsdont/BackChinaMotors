{% extends "admin/change_list.html" %}

{% block content %}
{% if crm_stats %}
<div style="margin-bottom:25px;padding:20px;background:#111;border-radius:10px;color:white;">
    <h2>üìä CRM Dashboard</h2>

    <p>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤: <b>{{ crm_stats.total_leads }}</b></p>
    <p>–°–¥–µ–ª–æ–∫: <b style="color:lime">{{ crm_stats.total_deals }}</b></p>
    <p>–ö–æ–Ω–≤–µ—Ä—Å–∏—è: <b style="color:orange">{{ crm_stats.conversion }}%</b></p>
    <p>–û–±—â–∏–π –¥–æ—Ö–æ–¥: <b style="color:#4CAF50">{{ crm_stats.total_revenue }} ‚Ç∏</b></p>
    <p>–°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å —Å —Å–¥–µ–ª–∫–∏: <b>{{ crm_stats.avg_profit }} ‚Ç∏</b></p>
</div>
{% endif %}

<div style="padding:15px; margin-bottom:20px; background:#111; border-radius:10px;">
    <h3 style="color:white;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–∏–¥–æ–≤</h3>
    <div style="color:white;">
        –í—Å–µ–≥–æ: {{ lead_stats.total }} |
        üî¥ New: {{ lead_stats.new }} |
        üü† Contacted: {{ lead_stats.contacted }} |
        üü¢ Deal: {{ lead_stats.deal }} |
        ‚ö´ Closed: {{ lead_stats.closed }}
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if revenue_chart %}
<canvas id="revenueChart" height="100"></canvas>

<script>
const data = {{ revenue_chart|safe }};

const labels = data.map(item => item.day);
const totals = data.map(item => item.total);

new Chart(document.getElementById("revenueChart"), {
    type: "line",
    data: {
        labels: labels,
        datasets: [{
            label: "–ü—Ä–∏–±—ã–ª—å –ø–æ –¥–Ω—è–º",
            data: totals,
            borderColor: "lime",
            backgroundColor: "rgba(0,255,0,0.1)",
            tension: 0.3
        }]
    },
    options: {
        plugins: {
            legend: { labels: { color: "white" } }
        },
        scales: {
            x: { ticks: { color: "white" } },
            y: { ticks: { color: "white" } }
        }
    }
});
</script>
{% endif %}
{% if top_products %}
<h2 style="margin-top:40px;">üèÜ –¢–æ–ø-–ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –ø—Ä–∏–±—ã–ª–∏</h2>

<table class="admin-table" style="width:100%; margin-top:15px;">
    <thead>
        <tr>
            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
            <th>–°–¥–µ–ª–æ–∫</th>
            <th>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</th>
        </tr>
    </thead>
    <tbody>
        {% for item in top_products %}
        <tr>
            <td>{{ item.product__title }}</td>
            <td>{{ item.total_deals }}</td>
            <td>{{ item.total_profit|default:0 }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
<div style="margin:20px 0; padding:20px; background:#111; color:#fff; border-radius:8px;">
    <h2>üìä –ö–æ–Ω–≤–µ—Ä—Å–∏—è</h2>
    <p><strong>–í—Å–µ–≥–æ –ª–∏–¥–æ–≤:</strong> {{ total_leads }}</p>
    <p><strong>–ó–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫:</strong> {{ total_deals }}</p>
    <p><strong>–ö–æ–Ω–≤–µ—Ä—Å–∏—è:</strong> {{ conversion }}%</p>
</div>
<div style="margin:20px 0; padding:20px; background:#0f172a; color:#fff; border-radius:8px;">
    <h2>üî• –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h2>
    <p>üÜï –ù–æ–≤—ã–µ: {{ funnel.new }}</p>
    <p>‚öô –í —Ä–∞–±–æ—Ç–µ: {{ funnel.in_progress }}</p>
    <p>üèÜ –ü—Ä–æ–¥–∞–Ω–æ: {{ funnel.won }}</p>
    <p>‚ùå –ü–æ—Ç–µ—Ä—è–Ω–æ: {{ funnel.lost }}</p>
</div>
{% if manager_stats %}
<h2 style="margin-top:40px;">üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>

<table style="width:100%; margin-top:15px;">
    <tr>
        <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
        <th>–°–¥–µ–ª–æ–∫</th>
        <th>–ü—Ä–∏–±—ã–ª—å</th>
    </tr>
    {% for item in manager_stats %}
    <tr>
        <td>{{ item.manager__phone }}</td>
        <td>{{ item.total_deals }}</td>
        <td>{{ item.total_profit }}</td>
    </tr>
    {% endfor %}
</table>
{% endif %}
{% if top_managers %}
<h2 style="margin-top:40px;">üëë –¢–æ–ø –º–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>

<table style="width:100%; margin-top:15px;">
    <thead>
        <tr>
            <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
            <th>–°–¥–µ–ª–æ–∫</th>
            <th>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</th>
        </tr>
    </thead>
    <tbody>
        {% for item in top_managers %}
        <tr>
            <td>{{ item.manager__phone }}</td>
            <td>{{ item.total_deals }}</td>
            <td>{{ item.total_profit|default:0 }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{{ block.super }}
{% endblock %}
